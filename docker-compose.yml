services:
  # =============================
  # API GATEWAY
  # =============================
  api-gateway:
    build: ./api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - auth-service
      - game-service
      - review-service
      - analytics-service
    environment:
      - PORT=8080
      - AUTH_URL=http://auth-service:4001
      - GAME_URL=http://game-service:4002
      - REVIEW_URL=http://review-service:4003
      - ANALYTICS_URL=http://analytics-service:4004
    networks:
      - indiehub-network
    restart: always

  # =============================
  # AUTH SERVICE (Node + Mongo)
  # =============================
  auth-service:
    build: ./auth-service
    environment:
      - PORT=4001
      - MONGO_URL=mongodb://auth-mongo:27017/authdb
      - JWT_SECRET=supersecret
    depends_on:
      - auth-mongo
    networks:
      - indiehub-network
    restart: always

  auth-mongo:
    image: mongo:6.0
    platform: linux/amd64
    volumes:
      - auth-mongo-data:/data/db
    ports:
      - "27018:27017"
    networks:
      - indiehub-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # =============================
  # GAME SERVICE (Node + Postgres)
  # =============================
  game-service:
    build: ./game-service
    environment:
      - PORT=4002
      - PG_HOST=games-postgres
      - PG_PORT=5432
      - PG_USER=postgres
      - PG_PASSWORD=postgres
      - PG_DB=gamesdb
    depends_on:
      - games-postgres
    networks:
      - indiehub-network
    restart: always

  games-postgres:
    image: postgres:15
    platform: linux/amd64
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=gamesdb
    volumes:
      - games-postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - indiehub-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d gamesdb" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  adminer:
    image: adminer
    ports:
      - "8081:8080"
    networks:
      - indiehub-network
    restart: always

  # =============================
  # REVIEW SERVICE (Python + FastAPI + Mongo)
  # =============================
  review-service:
    build: ./review-service
    environment:
      - PORT=4003
      - MONGO_URL=mongodb://review-mongo:27017/reviewsdb
      - AUTH_URL=http://auth-service:4001/auth/verify
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - review-mongo
      - auth-service
    networks:
      - indiehub-network
    restart: always

  review-mongo:
    image: bitnami/mongodb:latest
    platform: linux/amd64
    environment:
      - MONGODB_ROOT_PASSWORD=postgres
      - MONGODB_DATABASE=reviewsdb
    volumes:
      - review-mongo-data:/bitnami/mongodb
    ports:
      - "27019:27017"
    networks:
      - indiehub-network
    restart: always

  mongo-express:
    image: mongo-express
    ports:
      - "8082:8081"
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=root
      - ME_CONFIG_MONGODB_ADMINPASSWORD=postgres
      - ME_CONFIG_MONGODB_URL=mongodb://root:postgres@review-mongo:27017/reviewsdb
    depends_on:
      - review-mongo
    networks:
      - indiehub-network
    restart: always

  # =============================
  # ANALYTICS (Node + GraphQL)
  # =============================
  analytics-service:
    build: ./analytics-service
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - GAME_SERVICE_URL=http://game-service:4002
      - REVIEW_SERVICE_URL=http://review-service:4003
    depends_on:
      - game-service
      - review-service
    networks:
      - indiehub-network
    restart: always

  # =============================
  # RABBITMQ (ASYNC)
  # =============================
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - indiehub-network
    restart: always

  notification-service:
    build: ./notification-service
    depends_on:
      - rabbitmq
    networks:
      - indiehub-network
    restart: always

networks:
  indiehub-network:
    driver: bridge

volumes:
  auth-mongo-data:
  review-mongo-data:
  games-postgres-data:


